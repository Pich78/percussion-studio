<!-- file: src/components/InstrumentRowView/InstrumentRowView.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Harness: InstrumentRowView</title>
    <link rel="stylesheet" href="https://unpkg.com/tachyons@4.12.0/css/tachyons.min.css"/>
    <style> 
        body { font-family: sans-serif; } 
        .rows-wrapper {
            overflow-x: auto;
            border: 1px solid #ccc;
            padding: 8px;
            background-color: #f8f8f8;
        }
        .rows-inner-container {
            min-width: 100%; 
            width: fit-content;
        }
    </style>
</head>
<body class="bg-light-gray pa4">

    <div class="flex">
        <div class="w-70 pr3">
            <h1 class="f2 b mb3 bb pb2">Automated Tests</h1>
            <button id="run-tests-btn" class="pv2 ph3 bn br2 bg-blue white pointer hover-bg-dark-blue mb3">Run Automated Tests</button>
            <div id="test-results"></div>
            <hr class="mv4"/>
            <h1 class="f2 b mb3 bb pb2">Live View Workbench (Unit Test)</h1>
            
            <div class="bg-white shadow-2 pa3 mb3">
                <h3 class="f4 b mt0">Global Controls</h3>
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="mr3">
                            <label class="f6 b db mb2">Time Signature</label>
                            <input id="ts-numerator" type="number" value="4" class="w3 tc"> /
                            <input id="ts-denominator" type="number" value="4" class="w3 tc">
                        </div>
                        <div>
                            <label for="subdivision-select" class="f6 b db mb2">Subdivision</label>
                            <select id="subdivision-select" class="w5">
                                <option value="4">4th Notes</option>
                                <option value="8">8th Notes</option>
                                <option value="16" selected>16th Notes</option>
                                <option value="32">32nd Notes</option>
                                <option value="64">64th Notes</option>
                            </select>
                        </div>
                    </div>
                    <!-- NEW: Zoom Slider Control -->
                    <div class="w-30">
                        <label for="zoom-slider" class="f6 b db mb2">Zoom</label>
                        <input id="zoom-slider" type="range" min="0.5" max="2.5" value="1" step="0.1" class="w-100">
                    </div>
                </div>
                <hr class="mv3"/>
                <div id="rows-wrapper" class="rows-wrapper">
                    <div id="rows-inner-container" class="rows-inner-container">
                        <!-- InstrumentRowView components will be rendered here -->
                    </div>
                </div>
            </div>
            
            <div id="callback-log" class="f7 code pa2 bg-washed-yellow mt3 h4 overflow-y-auto">Callbacks will appear here.</div>
        </div>
        <div class="w-30 pl3">
            <div class="bg-near-black near-white pa3 br2 h-100">
                <h2 class="f4 b bb pb2 mb2">Execution Log</h2>
                <div id="log-output" class="f7 lh-copy" style="white-space: pre-wrap; height: 80vh; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <div id="test-sandbox" style="position: absolute; visibility: hidden;"></div>

    <script type="module">
        import { run } from './InstrumentRowView.test.js';
        import { InstrumentRowView } from './InstrumentRowView.js';
        import { Logger, logEvent } from '/percussion-studio/lib/Logger.js';

        Logger.init({ level: 'debug' });
        Logger.setTarget('log-output');

        document.getElementById('run-tests-btn').addEventListener('click', run);

        let mockState = {
            instruments: [
                { symbol: 'KCK', name: 'Kick Drum', sounds: [{letter: 'o', svg: '<svg>o</svg>'}, {letter: 'p', svg: '<svg>p</svg>'}] },
                { symbol: 'SNR', name: 'Snare Drum', sounds: [{letter: 'x', svg: '<svg>x</svg>'}, {letter: 'r', svg: '<svg>r</svg>'}] },
            ],
            pattern: {
                KCK: '||o-p-o-p-o-p-o-p-o-p-o-p-o-p-o-p-o-p-o-p-o-p-o-p-o-p-o-p-o-p-o-p-||',
                SNR: '||----x-------x-------x-------x-------x-------x-------x-------x---||',
            },
            metrics: {},
            // NEW: Zoom level state managed by the harness
            zoomLevel: 1 
        };

        const rowsWrapper = document.getElementById('rows-wrapper'); // Get the scroll container
        const rowsContainer = document.getElementById('rows-inner-container');
        const callbackLogEl = document.getElementById('callback-log');
        const componentInstances = new Map();
        
        function logCallback(name, data) {
            const entry = document.createElement('div');
            entry.textContent = `[${name}] Fired with: ${JSON.stringify(data)}`;
            callbackLogEl.appendChild(entry);
            callbackLogEl.scrollTop = callbackLogEl.scrollHeight;
        }

        function rerender() {
            rowsContainer.innerHTML = '';
            componentInstances.clear();

            mockState.instruments.forEach((inst) => {
                const container = document.createElement('div');
                rowsContainer.appendChild(container);

                const view = new InstrumentRowView(container, {
                    onRequestInstrumentChange: (symbol) => logCallback('onRequestInstrumentChange', { symbol }),
                    onCellMouseDown: (tickIndex, event) => logCallback('onCellMouseDown', { tickIndex }),
                    onGridMouseEnter: (instrument) => logCallback('onGridMouseEnter', { symbol: instrument.symbol }),
                    onGridMouseLeave: () => logCallback('onGridMouseLeave', {})
                });

                view.render({
                    instrument: inst,
                    notation: mockState.pattern[inst.symbol],
                    metrics: mockState.metrics
                });
                componentInstances.set(inst.symbol, view);
            });
        }

        const numeratorInput = document.getElementById('ts-numerator');
        const denominatorInput = document.getElementById('ts-denominator');
        const subdivisionSelect = document.getElementById('subdivision-select');
        // NEW: Get the zoom slider element
        const zoomSlider = document.getElementById('zoom-slider');

        // NEW: Function to apply dynamic styles based on state
        function updateStyles() {
            const baseCellWidth = 40; // The standard width at 1x zoom
            const newCellWidth = baseCellWidth * mockState.zoomLevel;
            // Set the CSS variable on the container
            rowsWrapper.style.setProperty('--cell-width', `${newCellWidth}px`);
        }

        function updateMetrics() {
            const beats = parseInt(numeratorInput.value, 10) || 4;
            const unit = parseInt(denominatorInput.value, 10) || 4;
            const subdivision = Number(subdivisionSelect.value);
            
            let grouping = (subdivision / unit);
            if ([6, 9, 12].includes(beats) && unit === 8) {
                grouping = 3;
            }

            mockState.metrics = {
                beatsPerMeasure: beats,
                beatUnit: unit,
                subdivision: subdivision,
                grouping: grouping
            };
            rerender();
        }

        // NEW: Event listener for the zoom slider
        zoomSlider.addEventListener('input', (event) => {
            mockState.zoomLevel = parseFloat(event.target.value);
            // We don't need to re-render the components, just update the style
            updateStyles();
        });

        [numeratorInput, denominatorInput, subdivisionSelect].forEach(el => {
            el.addEventListener('change', updateMetrics);
        });
        
        updateMetrics(); // Initial render
        updateStyles(); // Initial style application
    </script>
</body>
</html>