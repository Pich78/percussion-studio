<!-- file: src/components/RadialSoundSelector/RadialSoundSelector.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Harness: RadialSoundSelector</title>
    <link rel="stylesheet" href="https://unpkg.com/tachyons@4.12.0/css/tachyons.min.css"/>
    <!-- The menu uses the same CSS as the old component, just renamed -->
    <link rel="stylesheet" href="/percussion-studio/src/components/RadialSoundSelector/RadialSoundSelector.css">
    <style> body { font-family: sans-serif; cursor: default; } </style>
</head>
<body class="bg-light-gray pa4">

    <div class="flex">
        <div class="w-70 pr3">
            <h1 class="f2 b mb3 bb pb2">Automated Tests</h1>
            <button id="run-tests-btn" class="pv2 ph3 bn br2 bg-blue white pointer hover-bg-dark-blue mb3">Run Automated Tests</button>
            <div id="test-results"></div>
            <hr class="mv4"/>
            <h1 class="f2 b mb3 bb pb2">Live View Workbench</h1>
            
            <div class="bg-white shadow-2 pa3 mb3">
                <h3 class="f4 b mt0">Controls</h3>
                <p class="f6">1. Click a button below to choose which set of sounds will appear in the menu.</p>
                <p class="f6">2. Press and <strong>hold the mouse down</strong> on the gray canvas area to open the menu.</p>
                <div class="mb3">
                    <button id="btn-set-2" class="pv2 ph3 bn br2 bg-blue white pointer mr2">Set 1 (2 Sounds)</button>
                    <button id="btn-set-3" class="pv2 ph3 bn br2 bg-blue white pointer mr2">Set 2 (3 Sounds)</button>
                    <button id="btn-set-4" class="pv2 ph3 bn br2 bg-blue white pointer mr2">Set 3 (4 Sounds)</button>
                    <button id="btn-set-5" class="pv2 ph3 bn br2 bg-blue white pointer">Set 4 (5 Sounds)</button>
                </div>
                <div class="mt3">
                    <p class="f6 code" id="active-sound-display">Active Sound: o</p>
                </div>
            </div>
            
            <!-- This is the area where the press-and-hold interaction works -->
            <div id="interaction-canvas" class="bg-white shadow-2 pa3 mt4 flex items-center justify-center" style="height: 300px; border: 2px dashed #ccc; cursor: crosshair;">
                <p class="tc gray b">Press and hold here to test the radial menu.</p>
            </div>

            <div id="callback-log" class="f7 code pa2 bg-washed-yellow mt3 h4 overflow-y-auto">Callbacks will appear here.</div>
        </div>
        <div class="w-30 pl3">
            <div class="bg-near-black near-white pa3 br2 h-100">
                <h2 class="f4 b bb pb2 mb2">Execution Log</h2>
                <div id="log-output" class="f7 lh-copy" style="white-space: pre-wrap; height: 80vh; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <div id="test-sandbox" style="position: absolute; visibility: hidden;"></div>

    <script type="module">
        import { run } from './RadialSoundSelector.test.js';
        import { RadialSoundSelector } from './RadialSoundSelector.js';
        import { Logger, logEvent } from '/percussion-studio/lib/Logger.js';
        
        Logger.init({ level: 'debug' });
        Logger.setTarget('log-output');

        document.getElementById('run-tests-btn').addEventListener('click', run);
        logEvent('info', 'Harness', 'setup', 'Lifecycle', 'Setting up workbench for RadialSoundSelector...');

        // --- MOCK DATA ---
        const svg1 = '<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" stroke="black" stroke-width="8" fill="none"/></svg>';
        const svg2 = '<svg viewBox="0 0 100 100"><line x1="10" y1="10" x2="90" y2="90" stroke="black" stroke-width="8"/><line x1="10" y1="90" x2="90" y2="10" stroke="black" stroke-width="8"/></svg>';
        const svg3 = '<svg viewBox="0 0 100 100"><rect x="10" y="10" width="80" height="80" stroke="black" stroke-width="8" fill="none"/></svg>';
        const svg4 = '<svg viewBox="0 0 100 100"><polygon points="50,10 90,90 10,90" stroke="black" stroke-width="8" fill="none"/></svg>';
        const svg5 = '<svg viewBox="0 0 100 100"><polygon points="50,10 90,50 50,90 10,50" stroke="black" stroke-width="8" fill="none"/></svg>';

        const soundSets = {
            set2: [{letter: 'o', svg: svg1}, {letter: 'p', svg: svg2}],
            set3: [{letter: 'q', svg: svg1}, {letter: 'r', svg: svg2}, {letter: 's', svg: svg3}],
            set4: [{letter: 't', svg: svg1}, {letter: 'u', svg: svg2}, {letter: 'v', svg: svg3}, {letter: 'w', svg: svg4}],
            set5: [{letter: 'a', svg: svg1}, {letter: 'b', svg: svg2}, {letter: 'c', svg: svg3}, {letter: 'd', svg: svg4}, {letter: 'e', svg: svg5}]
        };

        const callbackLogEl = document.getElementById('callback-log');
        const activeSoundDisplayEl = document.getElementById('active-sound-display');
        const canvasEl = document.getElementById('interaction-canvas');
        const HOLD_DURATION_MS = 200;

        // --- STATE MANAGEMENT ---
        let activeSoundSet = soundSets.set2;
        let activeSoundLetter = soundSets.set2[0].letter;
        let holdTimeout = null;
        
        function logCallback(name, data) {
            const entry = document.createElement('div');
            entry.textContent = `[${name}] Fired with: ${JSON.stringify(data)}`;
            callbackLogEl.appendChild(entry);
            callbackLogEl.scrollTop = callbackLogEl.scrollHeight;
            logEvent('info', 'Harness', name, 'Callback', data);
        }

        function updateActiveSoundDisplay() {
            activeSoundDisplayEl.textContent = `Active Sound: ${activeSoundLetter}`;
            logEvent('info', 'Harness', 'updateState', 'StateChange', `Active sound is now '${activeSoundLetter}' from a set of ${activeSoundSet.length}.`);
        }

        // --- COMPONENT INSTANTIATION ---
        const radialMenu = new RadialSoundSelector({
            onSoundSelected: (selectedLetter) => {
                logCallback('onSoundSelected', selectedLetter);
                // Update the "active" sound, like changing the brush tip
                activeSoundLetter = selectedLetter;
                updateActiveSoundDisplay();
                // The owner is responsible for hiding the menu
                radialMenu.hide();
            }
        });

        // --- EVENT LISTENERS ---

        // Listeners for the buttons to change the active sound set
        document.getElementById('btn-set-2').addEventListener('click', () => {
            activeSoundSet = soundSets.set2;
            activeSoundLetter = activeSoundSet[0].letter;
            updateActiveSoundDisplay();
        });
        document.getElementById('btn-set-3').addEventListener('click', () => {
            activeSoundSet = soundSets.set3;
            activeSoundLetter = activeSoundSet[0].letter;
            updateActiveSoundDisplay();
        });
        document.getElementById('btn-set-4').addEventListener('click', () => {
            activeSoundSet = soundSets.set4;
            activeSoundLetter = activeSoundSet[0].letter;
            updateActiveSoundDisplay();
        });
        document.getElementById('btn-set-5').addEventListener('click', () => {
            activeSoundSet = soundSets.set5;
            activeSoundLetter = activeSoundSet[0].letter;
            updateActiveSoundDisplay();
        });

        // Listeners for the press-and-hold interaction on the canvas
        canvasEl.addEventListener('mousedown', (event) => {
            event.preventDefault(); // Prevents text selection
            
            holdTimeout = setTimeout(() => {
                logEvent('info', 'Harness', 'hold', 'UserAction', 'Hold detected, showing radial menu.');
                radialMenu.show({
                    x: event.clientX, y: event.clientY,
                    sounds: activeSoundSet,
                    activeSoundLetter: activeSoundLetter
                });
                holdTimeout = null; // Clear after running
            }, HOLD_DURATION_MS);
        });

        // Listen on the window to ensure we always catch the mouseup event
        window.addEventListener('mouseup', () => {
            if (holdTimeout) {
                clearTimeout(holdTimeout);
                logEvent('debug', 'Harness', 'mouseup', 'UserAction', 'Mouse up occurred before hold threshold.');
            }
        });
        
        logEvent('info', 'Harness', 'setup', 'Lifecycle', 'Workbench setup complete.');
        updateActiveSoundDisplay(); // Set initial display
    </script>
</body>
</html>