<!-- file: src/components/NoteEditorWidget/NoteEditorWidget.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Harness: NoteEditorWidget</title>
    <link rel="stylesheet" href="https://unpkg.com/tachyons@4.12.0/css/tachyons.min.css"/>
    <link rel="stylesheet" href="/percussion-studio/css/global.css">
    <link rel="stylesheet" href="/percussion-studio/lib/TubsGridRenderer/TubsGridRenderer.css">
    <style> body { font-family: sans-serif; cursor: default; } </style>
</head>
<body class="bg-light-gray pa4">

    <div class="flex">
        <div class="w-70 pr3">
            <h1 class="f2 b mb3 bb pb2">Automated Tests</h1>
            <button id="run-tests-btn" class="pv2 ph3 bn br2 bg-blue white pointer hover-bg-dark-blue mb3">Run Automated Tests</button>
            <div id="test-results"></div>
            <hr class="mv4"/>
            <h1 class="f2 b mb3 bb pb2">Live View Workbench</h1>
            <p class="f6 gray mb3">
                <b>New Interaction:</b> Press and hold on a cell, drag your mouse over a symbol in the palette, then release to select it. The note will be set and your "paintbrush" (cursor) will be updated.
            </p>
            <div class="bg-white shadow-2 pa3 mb3">
                <div id="track-1-container" class="instrument-track-container"></div>
                <div id="track-2-container" class="instrument-track-container"></div>
                <div id="track-3-container" class="instrument-track-container"></div>
                <div id="track-4-container" class="instrument-track-container"></div>
            </div>
            <div id="callback-log" class="f7 code pa2 bg-washed-yellow mt3 h4 overflow-y-auto">Callbacks will appear here.</div>
        </div>
        <div class="w-30 pl3">
            <div class="bg-near-black near-white pa3 br2 h-100">
                <h2 class="f4 b bb pb2 mb2">Execution Log</h2>
                <div id="log-output" class="f7 lh-copy" style="white-space: pre-wrap; height: 80vh; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <div id="test-sandbox" style="position: absolute; visibility: hidden;"></div>

    <script type="module">
        import { run } from './NoteEditorWidget.test.js';
        import { NoteEditorWidget } from './NoteEditorWidget.js';
        import { Logger, logEvent } from '/percussion-studio/lib/Logger.js';
        
        Logger.init({ level: 'debug' });
        Logger.setTarget('log-output');

        document.getElementById('run-tests-btn').addEventListener('click', run);
        
        logEvent('info', 'Harness', 'setup', 'Lifecycle', 'Setting up workbench...');

        const svg1 = '<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" stroke="black" stroke-width="8" fill="none"/></svg>';
        const svg2 = '<svg viewBox="0 0 100 100"><line x1="10" y1="10" x2="90" y2="90" stroke="black" stroke-width="8"/><line x1="10" y1="90" x2="90" y2="10" stroke="black" stroke-width="8"/></svg>';
        const svg3 = '<svg viewBox="0 0 100 100"><rect x="10" y="10" width="80" height="80" stroke="black" stroke-width="8" fill="none"/></svg>';
        const svg4 = '<svg viewBox="0 0 100 100"><polygon points="50,10 90,90 10,90" stroke="black" stroke-width="8" fill="none"/></svg>';
        const svg5 = '<svg viewBox="0 0 100 100"><polygon points="50,10 90,50 50,90 10,50" stroke="black" stroke-width="8" fill="none"/></svg>'; // Diamond
        
        let mockState = {
            instruments: [
                { symbol: 'KCK', name: 'Kick (2 Sounds)', sounds: [{letter: 'o', svg: svg1}, {letter: 'p', svg: svg2}] },
                { symbol: 'SNR', name: 'Snare (3 Sounds)', sounds: [{letter: 'x', svg: svg2}, {letter: 'r', svg: svg1}, {letter: 's', svg: svg3}] },
                { symbol: 'TOM', name: 'Tom (4 Sounds)', sounds: [{letter: 't', svg: svg1}, {letter: 'u', svg: svg2}, {letter: 'v', svg: svg3}, {letter: 'w', svg: svg4}] },
                // FIX: Corrected to have 5 sounds
                { symbol: 'HHC', name: 'Hi-Hat (5 Sounds)', sounds: [
                    {letter: 'c', svg: svg2}, {letter: 'o', svg: svg1}, {letter: 'p', svg: svg3},
                    {letter: 's', svg: svg4}, {letter: 'd', svg: svg5}
                ]},
            ],
            pattern: {
                KCK: '||o-p-o-p-o-p-o-p-||',
                SNR: '||----x-------x---||',
                TOM: '||t-u-v-w-t-u-v-w-||',
                HHC: '||c-c-c-c-c-c-c-c-||',
            },
            activeSounds: { KCK: 'o', SNR: 'x', TOM: 't', HHC: 'c' },
        };

        const callbackLogEl = document.getElementById('callback-log');
        const componentInstances = new Map();

        const logCallback = (instSymbol, name, data = {}) => {
            logEvent('info', 'Harness', name, 'Callback', `[${instSymbol}] Fired with:`, data);
            const entry = document.createElement('div');
            entry.textContent = `[${instSymbol}][${name}] ${JSON.stringify(data)}`;
            callbackLogEl.appendChild(entry);
            callbackLogEl.scrollTop = callbackLogEl.scrollHeight;
        };
        
        const rerender = () => {
            logEvent('debug', 'Harness', 'rerender', 'State', 'Rerendering all component instances.');
            for (const [symbol, instance] of componentInstances.entries()) {
                instance.render({
                    instrument: mockState.instruments.find(i => i.symbol === symbol),
                    notation: mockState.pattern[symbol],
                    activeSoundLetter: mockState.activeSounds[symbol],
                });
            }
        };

        mockState.instruments.forEach((inst, index) => {
            const container = document.getElementById(`track-${index + 1}-container`);
            const instance = new NoteEditorWidget(container, {
                onNoteEdit: (data) => {
                    logCallback(inst.symbol, 'onNoteEdit', data);
                    const chars = mockState.pattern[inst.symbol].replace(/\|/g, '').split('');
                    if (data.action === 'add' || data.action === 'set') {
                        chars[data.tickIndex] = data.soundLetter;
                    } else if (data.action === 'delete') {
                        chars[data.tickIndex] = '-';
                    }
                    mockState.pattern[inst.symbol] = `||${chars.join('')}||`;
                    rerender();
                },
                onActiveSoundChange: (newLetter) => {
                    logCallback(inst.symbol, 'onActiveSoundChange', { newLetter });
                    mockState.activeSounds[inst.symbol] = newLetter;
                    rerender();
                },
            });
            componentInstances.set(inst.symbol, instance);
        });
        
        rerender();
        logEvent('info', 'Harness', 'setup', 'Lifecycle', 'Workbench setup complete.');

    </script>
</body>
</html>